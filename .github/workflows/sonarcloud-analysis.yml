name: SonarCloud Analysis
on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'Stage-01-poc/**'
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'Stage-01-poc/**'

env:
  SOLUTION_DIR: Stage-02-new-architecture/Src

jobs:    
  SonarQubeForDotNet:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for SonarCloud analysis
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Install SonarCloud scanner
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Start SonarCloud analysis
          dotnet sonarscanner begin /k:"${{ secrets.SONAR_PROJECT_KEY }}" `
            /o:"${{ secrets.SONAR_ORGANIZATION }}" `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.host.url="https://sonarcloud.io" `
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" `
            /d:sonar.coverage.exclusions="**/Migrations/**" `
            /d:sonar.exclusions="Stage-01-poc/**"

          # Build the solution
          dotnet build ${{ env.SOLUTION_DIR }}/AssetTracker.sln --configuration Release

          # Run tests with coverage - use a unified approach
          dotnet test ${{ env.SOLUTION_DIR }}/AssetTracker.sln `
            --configuration Release `
            --no-build `
            --logger "trx;LogFileName=results.trx" `
            --collect:"XPlat Code Coverage" `
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

          # End SonarCloud analysis
          dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: Print directory tree
        shell: pwsh
        run: |
          Write-Host "=== Current Directory: $(Get-Location) ==="
          tree "$(Get-Location)" /F /A

      - name: List generated OpenCover reports
        shell: pwsh
        run: |
          Write-Host "=== Listing all coverage.opencover.xml files ==="
          Get-ChildItem -Path "${{ env.SOLUTION_DIR }}" -Recurse -Filter "coverage.opencover.xml" | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
          }

      - name: Inspect OpenCover XML contents
        shell: pwsh
        run: |
          $coverageFiles = Get-ChildItem -Path "${{ env.SOLUTION_DIR }}" -Recurse -Filter "coverage.opencover.xml"
          foreach ($file in $coverageFiles) {
              Write-Host "`n=== Showing first lines of: $($file.FullName) ==="
              Get-Content $file -Head 100 | Out-String
          }
      
      - name: Debug Sonar properties
        shell: pwsh
        run: |
          Write-Host "=== Contents of .sonarqube/out/sonar-project.properties ==="
          Get-Content ".sonarqube/out/sonar-project.properties" | Out-String

