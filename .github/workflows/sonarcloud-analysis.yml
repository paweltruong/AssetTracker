name: SonarCloud Analysis - Stage 02

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'Stage-02-new-architecture/Src/AssetTracker.sln'

jobs:
  analyze:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Verify solution file exists
      run: |
        if (!(Test-Path "${{ env.SOLUTION_PATH }}")) {
          Write-Error "Solution file not found at: ${{ env.SOLUTION_PATH }}"
          exit 1
        }
        Write-Host "âœ… Solution file found: ${{ env.SOLUTION_PATH }}"

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build Stage-02
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

    - name: Run tests with coverage
      shell: bash  # Force bash to use Linux-style line continuation
      run: |
        dotnet test Stage-02-new-architecture/Src/AssetTracker.sln \
          --configuration Release \
          --no-build \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage \
          --logger "trx;LogFileName=test-results.trx" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

    - name: Verify coverage files
      run: |
        if (Test-Path "./coverage") {
          Get-ChildItem "./coverage" -Recurse -Filter "*.cobertura.xml" | ForEach-Object { Write-Host "Found coverage file: $($_.FullName)" }
        } else {
          Write-Host "No coverage directory found"
        }

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          /d:sonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
          /d:sonar.organization=${{ secrets.SONAR_ORGANIZATION }}
          /d:sonar.sources=Stage-02-new-architecture/Src
          /d:sonar.tests=Stage-02-new-architecture/Src
          /d:sonar.exclusions=**/Stage-01-poc/**,**/bin/**,**/obj/**,**/*.csproj,**/*.config
          /d:sonar.coverage.exclusions=**/Stage-01-poc/**,**/Test/**/*,**/*Test/*,**/*.Tests/*,**/Migrations/*,**/Program.cs
          /d:sonar.cs.vscoveragexml.reportsPaths=./coverage/**/coverage.cobertura.xml
          /d:sonar.cpd.exclusions=**/Stage-01-poc/**
