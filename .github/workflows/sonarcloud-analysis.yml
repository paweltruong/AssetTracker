name: SonarCloud Analysis
on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'Stage-01-poc/**'
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'Stage-01-poc/**'

env:
  SOLUTION_DIR: Stage-02-new-architecture/Src

jobs:    
  SonarQubeForDotNet:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for SonarCloud analysis
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu' # Alternative distribution options are available.
          
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~\.sonar\cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
          
      - name: Cache SonarQube scanner
        id: cache-sonar-scanner
        uses: actions/cache@v4
        with:
          path: .\.sonar\scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner
          
      - name: Install SonarQube scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          New-Item -Path .\.sonar\scanner -ItemType Directory
          dotnet tool update dotnet-sonarscanner --tool-path .\.sonar\scanne
          r
      - name: Build and test
        shell: powershell
        run: |
          .\.sonar\scanner\dotnet-sonarscanner begin /k:"${{ secrets.SONAR_PROJECT_KEY }}" /o:"${{ secrets.SONAR_ORGANIZATION }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:"sonar.verbose=true" /d:"sonar.coverageReportPaths=SonarQube.xml"
          dotnet build ${{ env.SOLUTION_DIR }}/AssetTracker.sln
          dotnet test ${{ env.SOLUTION_DIR }}/AssetTracker.sln `
            --configuration Release `
            /p:CollectCoverage=true `
            /p:CoverletOutputFormat=cobertura `
            '/p:CoverletOutput=../../TestResults/$(MSBuildProjectName).coverage.cobertura.xml' `
            /p:EnableWindowsTargeting=true
          
      - name: Convert coverage report using ReportGenerator
        uses: danielpalme/ReportGenerator-GitHub-Action@v5.3.11
        with:
          reports: '${{ env.SOLUTION_DIR }}/TestResults/*.coverage.cobertura.xml'
          targetdir: '${{ env.SOLUTION_DIR }}/TestResults/CoverageReport'
          reporttypes: 'SonarQube'
          
      - name: Analyze
        shell: powershell
        run: |
          .\.sonar\scanner\dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
        env:
          SONAR_SCANNER_OPTS: >
            -Dsonar.coverageReportPaths=${{ env.SOLUTION_DIR }}/TestResults/CoverageReport/SonarQube.xml

      - name: Verify coverage outputs
        run: |
          echo "=== Listing generated coverage reports ==="
          dir Stage-02-new-architecture\Src\TestResults /s

