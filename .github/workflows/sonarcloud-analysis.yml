name: SonarCloud Analysis - Stage 02

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'Stage-02-new-architecture/Src/AssetTracker.sln'

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install tools
      run: dotnet tool install --global dotnet-reportgenerator-globaltool

    - name: Build non-WPF projects only
      run: |
        find Stage-02-new-architecture/Src -name "*.csproj" \
          ! -path "*/AssetsTracker.Wpf.Core/*" \
          ! -path "*/AssetTracker.WpfApp/*" \
          ! -name "*Wpf*" | xargs -I {} dotnet restore {}
        
        find Stage-02-new-architecture/Src -name "*.csproj" \
          ! -path "*/AssetsTracker.Wpf.Core/*" \
          ! -path "*/AssetTracker.WpfApp/*" \
          ! -name "*Wpf*" | xargs -I {} dotnet build {} --configuration Release --no-restore

    - name: Run tests with coverage
      run: |
        rm -rf ./coverage
        mkdir -p ./coverage
        
        find Stage-02-new-architecture/Src -name "*Tests.csproj" -o -name "*Test.csproj" \
          ! -path "*/AssetsTracker.Wpf.Core/*" \
          ! -path "*/AssetTracker.WpfApp/*" \
          ! -name "*Wpf*" | xargs -I {} dotnet test {} \
          --configuration Release \
          --no-build \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage \
          --logger "trx;LogFileName=test-results.trx"

    - name: Debug raw coverage
      run: |
        echo "=== Coverage files found ==="
        find ./coverage -name "*.xml" -type f
        echo "=== Sample coverage file structure ==="
        if find ./coverage -name "*.xml" | head -1 | grep -q .; then
          sample_file=$(find ./coverage -name "*.xml" | head -1)
          echo "First 20 lines of $sample_file:"
          head -20 "$sample_file"
        fi

    - name: Generate optimized SonarQube report
      run: |
        reportgenerator \
          -reports:"./coverage/**/*.xml" \
          -targetdir:"./sonar-coverage" \
          -reporttypes:"SonarQube" \
          -sourcedirs:"/github/workspace/Stage-02-new-architecture/Src" \
          -classfilters:"+AssetTracker.*" \
          -verbosity:"Warning"
        
        echo "=== Generated report info ==="
        ls -la ./sonar-coverage/
        echo "=== File paths in SonarQube.xml ==="
        grep -c 'filePath=' ./sonar-coverage/SonarQube.xml || echo "No filePath attributes found"
        grep -o 'filePath="[^"]*"' ./sonar-coverage/SonarQube.xml | head -5

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
          -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
          -Dsonar.sources=Stage-02-new-architecture/Src
          -Dsonar.tests=Stage-02-new-architecture/Src
          -Dsonar.exclusions=**/Stage-01-poc/**,**/bin/**,**/obj/**,**/*.csproj,**/*.config,**/AssetsTracker.Wpf.Core/**,**/AssetTracker.WpfApp/**
          -Dsonar.coverage.exclusions=**/Stage-01-poc/**,**/Test/**/*,**/*Test/*,**/*.Tests/*,**/Migrations/*,**/Program.cs,**/AssetsTracker.Wpf.Core/**,**/AssetTracker.WpfApp/**
          -Dsonar.coverageReportPaths=./sonar-coverage/SonarQube.xml
          -Dsonar.cpd.exclusions=**/Stage-01-poc/**,**/AssetsTracker.Wpf.Core/**,**/AssetTracker.WpfApp/**
          -Dsonar.scm.disabled=true
